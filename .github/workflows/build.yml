name: Android CI - 构建测试

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
    
    - name: ☕ 设置JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    - name: 🔧 授予gradlew执行权限
      run: chmod +x gradlew
    
    - name: 🏗️ 尝试构建Android应用
      continue-on-error: true
      run: |
        echo "开始构建..."
        ./gradlew assembleDebug --stacktrace 2>&1 | tee build.log
        echo "构建命令执行完成"
    
    - name: 📋 创建详细日志文件
      if: always()
      run: |
        echo "========================================" > detailed_log.txt
        echo "Android构建失败详细日志" >> detailed_log.txt
        echo "========================================" >> detailed_log.txt
        echo "" >> detailed_log.txt
        echo "构建时间: $(date)" >> detailed_log.txt
        echo "仓库: ${{ github.repository }}" >> detailed_log.txt
        echo "提交: ${{ github.sha }}" >> detailed_log.txt
        echo "" >> detailed_log.txt
        echo "========================================" >> detailed_log.txt
        echo "编译错误输出:" >> detailed_log.txt
        echo "========================================" >> detailed_log.txt
        cat build.log >> detailed_log.txt || echo "无法读取build.log" >> detailed_log.txt
        echo "" >> detailed_log.txt
        echo "========================================" >> detailed_log.txt
        echo "文件结构:" >> detailed_log.txt
        echo "========================================" >> detailed_log.txt
        find . -type f -name "*.java" >> detailed_log.txt
        
    - name: 📤 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          detailed_log.txt
          build.log
          **/*.log
        retention-days: 5
